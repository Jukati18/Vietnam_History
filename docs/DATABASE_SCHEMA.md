# Database Schema Documentation

Complete documentation for the MongoDB database structure used in the Vietnamese History project.

## Table of Contents

1. [Database Overview](#database-overview)
2. [Collections](#collections)
3. [Schema Definitions](#schema-definitions)
4. [Relationships](#relationships)
5. [Indexes](#indexes)
6. [Data Examples](#data-examples)
7. [Data Validation](#data-validation)
8. [Best Practices](#best-practices)

---

## Database Overview

### Database Name
```
vietnamese_history
```

### Technology
- **Database:** MongoDB Atlas (Cloud-hosted MongoDB)
- **Version:** MongoDB 6.0+
- **Driver:** Node.js MongoDB Driver 4.1+

### Collections Summary

| Collection | Purpose | Document Count (Typical) |
|------------|---------|--------------------------|
| `periods` | Main historical periods | 7 |
| `subPeriods` | Sub-divisions of periods | 20-30 |
| `events` | Historical events | 100-500+ |

---

## Collections

### 1. periods

Stores the main historical periods of Vietnamese history.

**Purpose:** Organize events into broad chronological and thematic categories.

**Key Features:**
- 7 major periods covering 4,000+ years
- Color-coded for visualization
- Ordered sequence for display

### 2. subPeriods

Stores sub-divisions within each main period.

**Purpose:** Provide more granular organization of historical events.

**Key Features:**
- Multiple sub-periods per period
- Inherits color from parent period (or has own)
- Chronologically ordered

### 3. events

Stores individual historical events with detailed information.

**Purpose:** Core data - actual historical events with location, dates, and descriptions.

**Key Features:**
- Linked to periods and sub-periods
- Geographical coordinates for mapping
- Full text search capability
- Rich metadata (tags, figures, significance)

---

## Schema Definitions

### periods Collection

```javascript
{
  "_id": ObjectId,              // MongoDB unique identifier
  "name": String,               // Display name (e.g., "Ancient Period")
  "nameVietnamese": String,     // Vietnamese name (optional)
  "slug": String,               // URL-friendly identifier (e.g., "ancient")
  "startYear": Number,          // Start year (negative for BC)
  "endYear": Number,            // End year
  "order": Number,              // Display order (1, 2, 3...)
  "color": String,              // Hex color code (e.g., "#8B4513")
  "description": String,        // Brief description of the period
  "characteristics": [String],  // Key characteristics (optional)
  "createdAt": Date,           // Timestamp (optional)
  "updatedAt": Date            // Timestamp (optional)
}
```

**Field Details:**

- **_id**: Automatically generated by MongoDB
- **name**: Required, unique display name in English
- **slug**: Required, unique, lowercase, no spaces (used in URLs)
- **startYear**: Required, integer (negative for BC dates)
- **endYear**: Required, integer
- **order**: Required, determines display sequence
- **color**: Required for visualization, must be valid hex color
- **description**: Optional but recommended

**Constraints:**
- `name` must be unique
- `slug` must be unique
- `startYear` < `endYear`
- `order` should be unique

### subPeriods Collection

```javascript
{
  "_id": ObjectId,              // MongoDB unique identifier
  "name": String,               // Display name
  "nameVietnamese": String,     // Vietnamese name (optional)
  "slug": String,               // URL-friendly identifier
  "periodId": ObjectId,         // Reference to parent period
  "startYear": Number,          // Start year
  "endYear": Number,            // End year
  "order": Number,              // Display order within period
  "color": String,              // Hex color (optional, inherits from period)
  "description": String,        // Description of sub-period
  "notableEvents": [String],    // Key events (optional)
  "createdAt": Date,           // Timestamp (optional)
  "updatedAt": Date            // Timestamp (optional)
}
```

**Field Details:**

- **periodId**: Required, must reference valid period._id
- **order**: Order within the parent period (1, 2, 3...)
- **color**: Optional, if not provided, uses parent period color

**Constraints:**
- `periodId` must reference existing period
- `startYear` >= parent period startYear
- `endYear` <= parent period endYear
- Multiple sub-periods can belong to one period

### events Collection

```javascript
{
  "_id": ObjectId,              // MongoDB unique identifier
  "title": String,              // Event title (English)
  "titleVietnamese": String,    // Event title (Vietnamese)
  "slug": String,               // URL-friendly identifier
  
  // Relationships
  "periodId": ObjectId,         // Reference to period
  "subPeriodId": ObjectId,      // Reference to sub-period (optional)
  
  // Date Information
  "date": {
    "year": Number,             // Year (negative for BC)
    "month": Number,            // Month (0-11, null if not specified)
    "day": Number,              // Day (1-31, null if not specified)
    "displayDate": String,      // Formatted display (e.g., "August 19, 1945 AD")
    "era": String              // "BC" or "AD"
  },
  
  // End date for events that span time
  "endDate": {                  // Optional, for period events
    "year": Number,
    "month": Number,
    "day": Number,
    "displayDate": String,
    "era": String
  },
  
  // Location Information
  "location": {
    "name": String,             // Location name (e.g., "Hanoi")
    "province": String,         // Province/region
    "region": String,           // Geographical region (optional)
    "coordinates": {            // For mapping
      "lat": Number,            // Latitude (-90 to 90)
      "lng": Number             // Longitude (-180 to 180)
    }
  },
  
  // Content
  "description": String,        // Full description (markdown supported)
  "shortDescription": String,   // Brief summary (1-2 sentences)
  "significance": String,       // Historical significance
  
  // People Involved
  "keyFigures": [{              // Array of people involved
    "name": String,
    "nameVietnamese": String,
    "role": String,             // Their role in the event
    "description": String       // Brief bio/description
  }],
  
  // Categorization
  "type": String,               // Event type (battle, treaty, founding, etc.)
  "tags": [String],            // Keywords for filtering/search
  
  // Related Content
  "relatedEventIds": [ObjectId], // Links to related events (optional)
  "sources": [String],          // Historical sources (optional)
  "images": [String],           // Image URLs (optional)
  
  // Metadata
  "featured": Boolean,          // Is this a featured event?
  "verified": Boolean,          // Has historical accuracy been verified?
  "views": Number,             // View count (optional)
  "createdAt": Date,           // Creation timestamp
  "updatedAt": Date            // Last update timestamp
}
```

**Field Details:**

**Title & Identification:**
- **title**: Required, primary display name in English
- **titleVietnamese**: Recommended for Vietnamese users
- **slug**: Required, unique, used in URLs

**Relationships:**
- **periodId**: Required, must reference valid period
- **subPeriodId**: Optional, must reference valid sub-period if provided

**Date Object:**
- **year**: Required, the year the event occurred
  - Positive integers for AD (e.g., 1945)
  - Negative integers for BC (e.g., -111 for 111 BC)
- **month**: Optional, 0-based (0 = January, 11 = December)
- **day**: Optional, 1-31 depending on month
- **displayDate**: Computed string for display
- **era**: "BC" or "AD" (computed from year)

**Location Object:**
- **name**: Required if location exists
- **coordinates**: Required for map display
  - lat: -90 to 90 (negative = south)
  - lng: -180 to 180 (negative = west)

**Content:**
- **description**: Full event description (can be long)
- **shortDescription**: Required, used in cards/lists
- **significance**: Why this event matters historically

**Key Figures Array:**
Each object represents a person involved:
- **name**: Person's name
- **role**: Their role (e.g., "Commander", "Emperor")
- **description**: Brief description of their involvement

**Event Types** (examples):
- `battle` - Military engagement
- `treaty` - Diplomatic agreement
- `founding` - Establishment of something
- `revolution` - Revolutionary event
- `independence` - Independence-related
- `war` - War declaration or major conflict
- `reform` - Political/social reform
- `cultural` - Cultural milestone
- `economic` - Economic event

**Constraints:**
- `title` required
- `periodId` must reference existing period
- If `subPeriodId` provided, must reference existing sub-period
- If `subPeriodId` provided, its periodId must match event's periodId
- `date.year` required
- If location provided, coordinates required for map display

---

## Relationships

### Entity Relationship Diagram

```
┌─────────────┐
│   periods   │
└──────┬──────┘
       │
       │ 1:N
       │
┌──────▼──────────┐
│   subPeriods    │
└──────┬──────────┘
       │
       │ 1:N
       │
┌──────▼──────┐
│   events    │
└─────────────┘
```

### Relationship Details

#### periods → subPeriods (One-to-Many)
- One period can have multiple sub-periods
- Sub-period's `periodId` references period's `_id`
- Cascade consideration: Deleting a period should handle orphaned sub-periods

#### periods → events (One-to-Many)
- One period can have multiple events
- Event's `periodId` references period's `_id`
- Required relationship

#### subPeriods → events (One-to-Many - Optional)
- One sub-period can have multiple events
- Event's `subPeriodId` references sub-period's `_id`
- Optional relationship (events can exist without sub-period)

#### events → events (Many-to-Many - Optional)
- Events can reference related events
- `relatedEventIds` array stores ObjectIds
- Self-referential relationship

### Querying Relationships

**Get all events in a period:**
```javascript
db.events.find({ 
  "periodId": ObjectId("...")
})
```

**Get all sub-periods of a period:**
```javascript
db.subPeriods.find({ 
  "periodId": ObjectId("...")
})
```

**Get all events in a sub-period:**
```javascript
db.events.find({ 
  "subPeriodId": ObjectId("...")
})
```

---

## Indexes

### Recommended Indexes

#### events Collection

```javascript
// Text index for search
db.events.createIndex({ 
  "title": "text", 
  "description": "text" 
})

// Period filtering
db.events.createIndex({ "periodId": 1 })

// Sub-period filtering
db.events.createIndex({ "subPeriodId": 1 })

// Date sorting and range queries
db.events.createIndex({ "date.year": 1 })

// Geospatial queries (for map features)
db.events.createIndex({ 
  "location.coordinates": "2dsphere" 
})

// Featured events
db.events.createIndex({ "featured": 1 })

// Tag filtering
db.events.createIndex({ "tags": 1 })
```

#### periods Collection

```javascript
// Display order
db.periods.createIndex({ "order": 1 })

// Unique slug
db.periods.createIndex({ "slug": 1 }, { unique: true })
```

#### subPeriods Collection

```javascript
// Display order within period
db.subPeriods.createIndex({ 
  "periodId": 1, 
  "order": 1 
})

// Period lookup
db.subPeriods.createIndex({ "periodId": 1 })
```

### Index Benefits

- **Text Search**: Fast full-text search on titles and descriptions
- **Period Filtering**: Quick event filtering by period
- **Date Sorting**: Efficient chronological ordering
- **Geospatial**: Fast "near me" queries for map features
- **Unique Constraints**: Prevent duplicate slugs

---

## Data Examples

### Example Period

```json
{
  "_id": { "$oid": "507f1f77bcf86cd799439011" },
  "name": "Ancient Period",
  "nameVietnamese": "Thời Cổ Đại",
  "slug": "ancient",
  "startYear": -2879,
  "endYear": -111,
  "order": 1,
  "color": "#8B4513",
  "description": "The ancient period of Vietnamese history, covering the legendary Hồng Bàng Dynasty and early kingdoms.",
  "characteristics": [
    "Legendary dynasties",
    "Formation of Vietnamese identity",
    "Agricultural development"
  ]
}
```

### Example Sub-Period

```json
{
  "_id": { "$oid": "507f1f77bcf86cd799439012" },
  "name": "Hồng Bàng Dynasty",
  "nameVietnamese": "Nhà Hồng Bàng",
  "slug": "hong-bang",
  "periodId": { "$oid": "507f1f77bcf86cd799439011" },
  "startYear": -2879,
  "endYear": -258,
  "order": 1,
  "color": "#A0522D",
  "description": "The legendary first dynasty of Vietnam, founded by Kinh Dương Vương and ruled by the Hùng Kings.",
  "notableEvents": [
    "Founding of Văn Lang",
    "Rule of the Hùng Kings"
  ]
}
```

### Example Event

```json
{
  "_id": { "$oid": "507f1f77bcf86cd799439013" },
  "title": "Battle of Bạch Đằng",
  "titleVietnamese": "Trận Bạch Đằng",
  "slug": "battle-bach-dang-938",
  "periodId": { "$oid": "507f1f77bcf86cd799439011" },
  "subPeriodId": { "$oid": "507f1f77bcf86cd799439012" },
  "date": {
    "year": 938,
    "month": null,
    "day": null,
    "displayDate": "938 AD",
    "era": "AD"
  },
  "location": {
    "name": "Bạch Đằng River",
    "province": "Quảng Ninh",
    "region": "Northern Vietnam",
    "coordinates": {
      "lat": 20.9578,
      "lng": 106.8370
    }
  },
  "description": "The Battle of Bạch Đằng was a decisive naval battle fought in 938 on the Bạch Đằng River. Vietnamese forces led by Ngô Quyền defeated the Southern Han fleet, ending over 1,000 years of Chinese domination and establishing Vietnamese independence.",
  "shortDescription": "Decisive naval victory that ended Chinese domination of Vietnam.",
  "significance": "This battle marked the end of over a millennium of Chinese rule and established Vietnam as an independent nation. It is considered one of the most important military victories in Vietnamese history.",
  "keyFigures": [
    {
      "name": "Ngô Quyền",
      "nameVietnamese": "Ngô Quyền",
      "role": "Vietnamese Commander",
      "description": "Leader of Vietnamese forces who used innovative tactics with iron-tipped stakes in the river to defeat the Chinese fleet."
    }
  ],
  "type": "battle",
  "tags": ["independence", "naval battle", "victory"],
  "featured": true,
  "verified": true,
  "sources": [
    "Đại Việt Sử Ký Toàn Thư",
    "Vietnamese Historical Records"
  ]
}
```

---

## Data Validation

### Validation Rules

#### At Application Level (server.js)

```javascript
// Example validation for creating event
function validateEvent(eventData) {
  const errors = [];
  
  // Required fields
  if (!eventData.title) errors.push("Title is required");
  if (!eventData.periodId) errors.push("Period ID is required");
  if (!eventData.date || !eventData.date.year) {
    errors.push("Date with year is required");
  }
  
  // Year validation
  if (eventData.date && eventData.date.year) {
    if (eventData.date.year > 2100) {
      errors.push("Year cannot be in the future");
    }
  }
  
  // Coordinates validation
  if (eventData.location && eventData.location.coordinates) {
    const { lat, lng } = eventData.location.coordinates;
    if (lat < -90 || lat > 90) {
      errors.push("Invalid latitude");
    }
    if (lng < -180 || lng > 180) {
      errors.push("Invalid longitude");
    }
  }
  
  return errors;
}
```

#### MongoDB Schema Validation (Optional)

```javascript
db.createCollection("events", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["title", "periodId", "date"],
      properties: {
        title: {
          bsonType: "string",
          description: "must be a string and is required"
        },
        date: {
          bsonType: "object",
          required: ["year"],
          properties: {
            year: {
              bsonType: "int",
              description: "must be an integer"
            }
          }
        }
      }
    }
  }
})
```

---

## Best Practices

### 1. Data Entry

**Dates:**
- Always provide year
- Use negative numbers for BC dates
- Be consistent with month (0-based) and day
- Generate displayDate consistently

**Locations:**
- Verify coordinates are accurate
- Use decimal degrees format
- Include descriptive names

**Descriptions:**
- Write clear, concise descriptions
- Use shortDescription for previews (max 150 characters)
- Include significance for important events

### 2. Relationships

**Period Assignment:**
- Every event must have a periodId
- Only assign subPeriodId if applicable
- Ensure subPeriod matches the period

**Related Events:**
- Link related events for better discovery
- Don't create circular references
- Update both events when creating relationship

### 3. Performance

**Querying:**
- Use indexes for filtering
- Limit result sets when possible
- Use projections to return only needed fields

**Updates:**
- Update in batches when possible
- Use updateMany for bulk operations
- Update updatedAt timestamp

### 4. Data Quality

**Before Adding Events:**
- Verify historical accuracy
- Check for duplicates
- Ensure proper categorization
- Validate coordinates on map

**Regular Maintenance:**
- Review and update descriptions
- Fix broken relationships
- Update deprecated information
- Remove test data

### 5. Naming Conventions

**Slugs:**
- Use lowercase
- Replace spaces with hyphens
- Remove special characters
- Keep short but descriptive
- Example: `battle-bach-dang-938`

**Field Names:**
- Use camelCase for consistency
- Be descriptive but concise
- Avoid abbreviations unless common

---

## Migration Scripts

### Adding New Fields

```javascript
// Add featured flag to all events
db.events.updateMany(
  { featured: { $exists: false } },
  { $set: { featured: false } }
)

// Add views counter
db.events.updateMany(
  { views: { $exists: false } },
  { $set: { views: 0 } }
)
```

### Data Cleanup

```javascript
// Remove events with no period
db.events.deleteMany({ 
  periodId: { $exists: false } 
})

// Fix null coordinates
db.events.updateMany(
  { "location.coordinates": null },
  { $unset: { "location.coordinates": "" } }
)
```

### Bulk Import Template

```javascript
// Import events from CSV/JSON
const events = [/* array of event objects */];

db.events.insertMany(events, { ordered: false });
```

---

## Future Schema Enhancements

Potential additions for future versions:

1. **User Collections:**
   - `users` - User accounts
   - `favorites` - User saved events
   - `comments` - User comments

2. **Media Collections:**
   - `images` - Image metadata
   - `documents` - Historical documents
   - `videos` - Video content

3. **Additional Event Fields:**
   - `casualties` - For battles
   - `participants` - Number of people
   - `outcome` - Event result
   - `legacy` - Long-term impact

4. **Localization:**
   - Multi-language support
   - Translated descriptions
   - Regional variations

---

**Schema Version:** 1.0.0
**Last Updated:** January 2026